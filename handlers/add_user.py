from telegram import Update
from telegram.ext import ContextTypes, CommandHandler
import psutil

async def add_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_authorized(update.effective_user.id):
        return await update.message.reply_text("ğŸš« Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰Ñ‘Ğ½.")
    
    if len(context.args) < 2:
        return await update.message.reply_text("Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: /adduser username password")
    
    username = context.args[0]
    password = context.args[1]

    # ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ° Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸ Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½ÑƒÑ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ)
    try:
        # ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞµÑÑ‚ÑŒ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ create_user.sh ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ¸Ğ¼Ñ Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
        result = subprocess.run(
            ["./create_user.sh", username, password],
            capture_output=True, text=True, check=True
        )
        await update.message.reply_text(f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {username} ÑĞ¾Ğ·Ğ´Ğ°Ğ½.\n{result.stdout}")
    except subprocess.CalledProcessError as e:
        await update.message.reply_text(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:\n{e.stderr}")

def get_adduser_handler():
    return CommandHandler("adduser", add_user)